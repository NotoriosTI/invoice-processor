name: Deploy to GCP

on:
  push:
    branches:
      - main

env:
  GAR_REGISTRY: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }} # Define el registry de GAR
  GAR_REPOSITORY: invoice-processor-repo # Define el nombre del repositorio en GAR

jobs:
  build-and-push-to-gar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Autenticarse en Google Cloud (para push a GAR)
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Configurar Docker para usar el Docker CLI credential helper para GCR/GAR
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      # Construir y subir la imagen a Google Artifact Registry
      - name: Build and push to GAR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.GAR_REGISTRY }}/${{ env.GAR_REPOSITORY }}/invoice-processor:latest

  deploy:
    needs: build-and-push-to-gar
    runs-on: self-hosted # Esto debe ejecutarse en tu VM de GCP
    steps:
      # No es necesario Checkout aqu√≠ si solo usamos SSH para ejecutar comandos.

      - name: Deploy and Run Health Checks
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Configurar Docker para usar el Docker CLI credential helper para GCR/GAR en la VM
            # Esto usa las credenciales del Service Account de la VM
            gcloud auth configure-docker ${{ env.GAR_REGISTRY }} --project ${{ secrets.GCP_PROJECT_ID }}

            # Navegar a la carpeta de despliegue en la VM
            cd /opt/invoice

            # Descargar la imagen m√°s reciente desde Google Artifact Registry
            docker pull ${{ env.GAR_REGISTRY }}/${{ env.GAR_REPOSITORY }}/invoice-processor:latest

            # Detener y reiniciar el servicio con la nueva imagen
            docker-compose down
            docker-compose up -d

            echo "‚úÖ Despliegue completado. Esperando 15s para que inicie el servicio..."
            sleep 15

            # Ejecutar Health Checks en la VM...
            echo "üîç Ejecutando Health Checks en la VM..."
            docker-compose exec invoice-processor python -m tests.deployment.check_gcp_secrets
            docker-compose exec invoice-processor python -m tests.deployment.check_llm
            docker-compose exec invoice-processor python -m tests.deployment.check_odoo
            echo "üéâ Todos los health checks pasaron."